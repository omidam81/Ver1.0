@model Teeyoot.Dashboard.ViewModels.PromotionViewModel

@{
    Style.Include("Promotions.css");
    Style.Include("//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css");
    Style.Include("Settings.css");
    Script.Include("promotion.js").AtFoot();
    Script.Require("jQuery");
    Script.Require("jQueryUI");
}
@using (Html.BeginForm(actionName: "ChangeState", controllerName: "Dashboard", routeValues: null, method: FormMethod.Post, htmlAttributes: new { @class = "form-validator" }))
{
    @Html.AntiForgeryToken();
}
@using (Script.Foot())
{
    <script>
        $("#datepicker").datepicker({
            dateFormat: "dd.mm.yy",
            minDate: 0,
        })
        document.title = "Promotions | Teeyoot";
        function showCalendar() {
            return $("#datepicker").datepicker("show");
        }


        function addAntiForgeryToken(data) {
            data.__RequestVerificationToken = "@Html.AntiForgeryTokenValueOrchard()";
            return data;
        };

        var token = $('input[name="__RequestVerificationToken"]').val();
        $.ajaxPrefilter(function (options, originalOptions) {
            if (options.type.toUpperCase() == "POST") {
                options.data = $.param($.extend(originalOptions.data, { __RequestVerificationToken: token }));
            }
        })


        function changeState(id)
        {

            var args = {};
            args.switchState = document.getElementById('switchState').checked;
            args.id = id;
            var token = $('input[name="__RequestVerificationToken"]').val();

           var headers = {};

            headers['__RequestVerificationToken'] = token;

            $.ajax({

                async: false,
                cache: false,
                type: "POST",
                url: "@Url.Action("ChangeState", "Dashboard")",
                data: addAntiForgeryToken({"id" : args.id, "switchState": args.switchState}),
                success: function (msg) {
                    // Something afterwards here

                }
            });

        }
</script>
}

<div class="dashboard-section-title">
    @T("Promotions")
    <span class="menu-closer" onclick="toggleMobileMenu()"><i class="fa fa-angle-up"></i></span>
    <span class="menu-opener" onclick="toggleMobileMenu()"><i class="fa fa-angle-down"></i></span>
</div>

<div class="dashboard__info_message">
    <p class="promotions__explanation">@T("Promotions are special discounts you can offer your customers. When applied, promotions are deducted from a campaign&#39;s profit margin. If there is not a sufficient profit margin, the promotion will not be eligible.")</p>
    <div class="share_promotions">
        @T("Share promotions by appending the ID to the end of your campaign URL.")<div class="share_promotions__example">
            @T("(e.g., ")<span class="share_promotions__url">http://teebay.com/yourcampaign</span><strong class="share_promotions__query">?promo=PROMOID</strong>)
        </div>
    </div>
</div>

<section class="account__email_settings">
    <div class="dashboard_section__header">
        <h1 class="dashboard_section__heading">@T("Add New Promotion")</h1>
    </div>
    @using (Html.BeginForm("AddPromotion", "Dashboard", FormMethod.Post))
    {
        @Html.AntiForgeryToken()
        <div class="dashboard_section__content--padded">
            <div class="new_promotion__form">
                <div class="new_promotion__code">
                    <div class="label__title">@T("Promo ID")</div>
                    <div class="input__group new_promotion__field">
                        @Html.TextBoxFor(m => m.PromoId, new { @class = "form__textfield ", @id = "code", @maxlength = "10", @name = "code", @type = "text", @value = "", @required= "true" })             
                        <span class="reload new_promotion__generate_code ts-icon-reload" id="code" maxlength="10" name="code" type="text" value="" onclick="randomString()" />
                    </div>
                    @Html.ValidationMessageFor(m => m.Promotions)
                </div>
                <div class="new_promotion__type">
                    <div class="label__title">Type</div>
                    @Html.TextBoxFor(m => m.DiscountType, new { @class = "form__textfield ", @id = "code", @maxlength = "10", @name = "code", @type = "text", Value = T("Discount"), @readonly = "true" })
                </div>
                <div class="new_promotion__discount">
                    <div class="label__title">Amount</div>
                    <div class="input__group new_promotion__field">
                        @Html.TextBoxFor(m => m.AmountSize, new { @class = "form__textfield ", @id = "code", @name = "amountSize", @type = "text", Value = "" })
                        @Html.DropDownListFor(m => m.AmountType, Model.AvailableCurrencies, new { @class = "form__select_menu" })
                    </div>
                </div>
                <div class="new_promotion__expiration">
                    <div class="label__title">Expiration</div>
                    <div class="input__group new_promotion__field">
                        @Html.TextBoxFor(m => m.Expiration, new { @class = "form__textfield ", @id = "datepicker", @name = "calendar", @type = "text", Value = "", @placeholder=T("Never") , @readonly="readonly"})
                        <span id="calendar" class="new_promotion__clear_expiration clndr_button" style="border: 1px solid #e8eced;" onclick="showCalendar()">
                            <i class="ts-icon-calendar calendar__button"></i>
                        </span>
                    </div>
                </div>
                <div class="new_promotion__save__container">
                    <input name="commit" class="add-button" type="submit" value="+">
                </div>
            </div>
        </div>
    }
</section>

@using (Html.BeginForm("AddPromotion", "Dashboard", FormMethod.Post))
{
    @Html.AntiForgeryToken()
<section class="account__password_settings">
    <div id="allPromotions" class="dashboard_section__header">
        <h1 class="dashboard_section__heading">@T("All promotions")</h1>

    </div>
    <div id="promotionList" class="dashboard_section__content--padded">


        <div class="list__container">
            <div class="list_item list_item--heading">
                <div class="list_item__cell code__heading">@T("Promo ID")</div>
                <div class="list_item__cell discount__heading">@T("Amount")</div>
                <div class="list_item__cell expiration__heading">@T("Expires")</div>
                <div class="list_item__cell used__heading">@T("Redeemed")</div>
                <div class="list_item__cell status__heading">@T("Status")</div>
                <div id="action"  class="list_item__cell actions__heading"></div>
            </div>
            @foreach (var promotion in Model.Promotions)
            {
                var expiration = "";
                if (@promotion.Expiration.Year == DateTime.MaxValue.Year)
                {
                    expiration = "-";
                }
                else
                {
                    expiration = @promotion.Expiration.ToString("dd/MM/yyyy");
                }
                <div class="list_item" data-id="39431">
                    <div class="list_item__cell list_item__code">@promotion.PromoId</div>
                    <div class="list_item__cell list_item__discount">@promotion.AmountSize@promotion.AmountType</div>
                    <div class="list_item__cell list_item__expiration">@expiration</div>
                    <div class="list_item__cell list_item__redeemed">@promotion.Redeemed</div>
                    <div class="list_item__cell list_item__status">
                        <label class="switch__label">

                            <input id="switchState" checked="@promotion.Status" class="switch__input promotion__status__checkbox" name="active" type="checkbox" onclick="changeState(@promotion.Id)" />
                            <div class="switch__el" data-off="Off" data-on="On"></div>
                        </label>
                    </div>
                    <div id="action" class="list_item__cell list_item__actions"><a href="@Url.Action("DeletePromotion", new {id = promotion.Id })" class="ts-icon-close delete_promotion__button"></a></div>
                </div>
            }
        </div>

    </div>
</section>
}